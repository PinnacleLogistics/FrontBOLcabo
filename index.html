<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Number Highlighter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
    }
    .number {
      background-color: yellow;
      font-weight: bold;
      display: block;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h3>Highlighted Numbers</h3>
  <div id="numbers"></div>
  <script>
    // Plugin manifest as a JavaScript object
    const manifest = {
      "description": "Highlight 11-digit numbers starting with 60 in selected emails.",
      "title": "Number Highlighter",
      "icon": "icon.png",
      "external": {
        "sidebar": {
          "url": "sidebar.html",
          "size": 300
        }
      }
    };

    // Function to fetch and analyze email content
    async function fetchEmailContent() {
      try {
        // Get the selected conversation ID from Front context
        const conversationId = await Front.context.conversation.getId();

        // Fetch conversation details using Front API
        const response = await fetch(`https://api2.frontapp.com/conversations/${conversationId}`, {
          headers: {
            'Authorization': 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzY29wZXMiOlsicHJpdmF0ZToqIiwic2hhcmVkOioiXSwiaWF0IjoxNzE2MDkyOTUxLCJpc3MiOiJmcm9udCIsInN1YiI6ImU3NTg0NmQwOWU5ZGVlNmU5YjgzIiwianRpIjoiNjdlMjAyNmJjMzIzZWJjYyJ9.KVxqsdNwTCjZG7G1IpaBSjKomOaLB6R08cVvieqic7M',
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Network response was not ok ' + response.statusText);
        }

        const data = await response.json();
        const messages = data._results;
        
        let text = '';
        
        // Extract the subject, body, and comments from each message
        messages.forEach(message => {
          if (message.subject) {
            text += message.subject + ' ';
          }
          if (message.body) {
            text += message.body + ' ';
          }
          if (message.comments) {
            message.comments.forEach(comment => {
              text += comment.body + ' ';
            });
          }
        });

        // Extract numbers from the combined text
        const numbers = extractNumbers(text);

        // Display numbers in the sidebar
        displayNumbers(numbers);
      } catch (error) {
        console.error('Error fetching email content:', error);
      }
    }

    // Function to extract 11-digit numbers starting with 60
    function extractNumbers(text) {
      const regex = /\b60\d{9}\b/g;
      return text.match(regex) || [];
    }

    // Function to display numbers in the sidebar
    function displayNumbers(numbers) {
      const numbersDiv = document.getElementById('numbers');
      numbersDiv.innerHTML = '';

      numbers.forEach(number => {
        const div = document.createElement('div');
        div.className = 'number';
        div.textContent = number;
        numbersDiv.appendChild(div);
      });
    }

    // Fetch and analyze email content when the conversation is switched
    Front.on('conversation.switch', function () {
      fetchEmailContent();
    });

    // Initial fetch and analyze email content on load
    fetchEmailContent();
  </script>
</body>
</html>
